<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Binance Demo Bot</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap');
:root{
  --bg:#0a0a0f;--surface:#111118;--card:#16161f;--border:#222232;
  --accent:#f0b90b;--green:#00e676;--red:#ff4d6d;--yellow:#ffd166;
  --text:#d0d0e8;--dim:#555570;
  --mono:'Space Mono',monospace;--sans:'Space Grotesk',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:var(--sans);display:flex;flex-direction:column;height:100dvh}

/* â”€â”€ HEADER â”€â”€ */
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.logo{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px}
.logo-icon{color:var(--accent);font-size:20px}
.logo em{color:var(--accent);font-style:normal}
.hdr-r{display:flex;align-items:center;gap:6px}
.badge{font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:1px;padding:3px 8px;border-radius:4px}
.b-demo{background:rgba(240,185,11,.15);color:var(--accent);border:1px solid rgba(240,185,11,.35)}
.b-run{background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.3);animation:blink 2s infinite}
.b-off{background:rgba(85,85,112,.15);color:var(--dim);border:1px solid var(--border)}
@keyframes blink{50%{opacity:.5}}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0}
.tab{flex:1;padding:10px 2px;text-align:center;font-size:10px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* â”€â”€ SCROLL â”€â”€ */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.scroll::-webkit-scrollbar{display:none}
.page{display:none;padding:14px}
.page.active{display:block}

/* â”€â”€ BANNERS â”€â”€ */
.banner{display:flex;align-items:center;gap:8px;border-radius:10px;padding:10px 12px;margin-bottom:12px;font-size:12px;border:1px solid;transition:all .4s}
.bn-ok{background:rgba(0,230,118,.07);border-color:rgba(0,230,118,.25);color:var(--green)}
.bn-err{background:rgba(255,77,109,.07);border-color:rgba(255,77,109,.25);color:var(--red)}
.bn-warn{background:rgba(240,185,11,.07);border-color:rgba(240,185,11,.25);color:var(--yellow)}
.bn-info{background:rgba(124,111,255,.07);border-color:rgba(124,111,255,.25);color:#a0a0ff}
.bn-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:currentColor}
.bn-dot.pulse{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ TICKER â”€â”€ */
.ticker-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:9px 14px;margin-bottom:12px;overflow:hidden}
.ticker-inner{display:flex;gap:20px;width:max-content}
.ticker-inner.go{animation:scrollT 35s linear infinite}
@keyframes scrollT{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.ti{display:flex;align-items:center;gap:5px;white-space:nowrap}
.ti-s{font-size:11px;font-weight:700}
.ti-p{font-family:var(--mono);font-size:11px}
.ti-c{font-family:var(--mono);font-size:10px}

/* â”€â”€ STAT GRID â”€â”€ */
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.sb{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;position:relative;overflow:hidden}
.sb::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%}
.la::before{background:var(--accent)} .lg::before{background:var(--green)}
.lr::before{background:var(--red)}    .ly::before{background:var(--yellow)}
.sl{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--dim);margin-bottom:5px}
.sv{font-family:var(--mono);font-size:18px;font-weight:700}
.sv.g{color:var(--green)} .sv.r{color:var(--red)} .sv.a{color:var(--accent)} .sv.y{color:var(--yellow)}
.ss{font-size:10px;color:var(--dim);margin-top:3px}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px}
.chdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.ct{font-size:10px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--dim)}
.ca{font-size:11px;color:var(--accent);cursor:pointer;font-weight:600}

/* â”€â”€ PROGRESS â”€â”€ */
.pw{margin:8px 0}
.pm{display:flex;justify-content:space-between;font-size:11px;color:var(--dim);margin-bottom:4px}
.pb{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.pf{height:100%;border-radius:3px;transition:width .6s}

/* â”€â”€ CHART â”€â”€ */
canvas.pnl{width:100%;height:80px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{width:100%;padding:13px;border:none;border-radius:10px;font-family:var(--sans);font-size:14px;font-weight:700;cursor:pointer;transition:all .15s}
.btn:active{transform:scale(.96)}
.btn-y{background:var(--accent);color:#000}
.btn-g{background:var(--green);color:#000}
.btn-r{background:var(--red);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.b2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}

/* â”€â”€ TRADE ROW â”€â”€ */
.tr{display:flex;align-items:flex-start;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);gap:8px}
.tr:last-child{border-bottom:none}
.tr-sym{font-size:14px;font-weight:700}
.tr-meta{font-size:10px;color:var(--dim);margin-top:3px}
.chip{display:inline-block;font-size:8px;font-weight:700;letter-spacing:.8px;padding:2px 5px;border-radius:3px;margin-right:3px}
.c-long{background:rgba(0,230,118,.12);color:var(--green)}
.c-short{background:rgba(255,77,109,.12);color:var(--red)}
.c-open{background:rgba(240,185,11,.12);color:var(--accent)}
.c-win{background:rgba(0,230,118,.12);color:var(--green)}
.c-loss{background:rgba(255,77,109,.12);color:var(--red)}
.tr-pnl{font-family:var(--mono);font-size:14px;font-weight:700}

/* â”€â”€ SCAN ROW â”€â”€ */
.srow{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);gap:10px;cursor:pointer}
.srow:last-child{border-bottom:none}
.srow:active{opacity:.7}
.sico{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;font-weight:700}

/* â”€â”€ FORM â”€â”€ */
.fr{margin-bottom:12px}
.fl{font-size:10px;letter-spacing:.8px;text-transform:uppercase;color:var(--dim);margin-bottom:5px;display:block}
.fi{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px 12px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;transition:border-color .2s}
.fi:focus{border-color:var(--accent)}
.fi.pw-field{letter-spacing:2px}
.fs{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px 12px;color:var(--text);font-size:13px;outline:none;-webkit-appearance:none}
.f2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.eye-wrap{position:relative}
.eye-wrap .fi{padding-right:44px}
.eye-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--dim);cursor:pointer;font-size:16px;padding:4px}

/* â”€â”€ TOGGLE â”€â”€ */
.trow{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
.trow:last-child{border-bottom:none}
.tn{font-size:13px;font-weight:500}
.td{font-size:10px;color:var(--dim);margin-top:2px}
.tog{width:42px;height:23px;background:var(--border);border-radius:12px;position:relative;cursor:pointer;transition:background .25s;flex-shrink:0}
.tog.on{background:var(--accent)}
.tog::after{content:'';position:absolute;width:17px;height:17px;border-radius:50%;background:#fff;top:3px;left:3px;transition:left .25s}
.tog.on::after{left:22px}

/* â”€â”€ LOG â”€â”€ */
.logbox{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;height:240px;overflow-y:auto;font-family:var(--mono);font-size:10px;line-height:1.8}
.logbox::-webkit-scrollbar{display:none}
.ll.info{color:var(--text)} .ll.ok{color:var(--green)} .ll.warn{color:var(--yellow)} .ll.err{color:var(--red)}
.ll .lt{color:var(--dim);margin-right:6px}

/* â”€â”€ MISC â”€â”€ */
.empty{text-align:center;color:var(--dim);font-size:12px;padding:24px 0}
.ei{font-size:28px;margin-bottom:6px}
.sec-lbl{font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--dim);margin:14px 0 8px}
.divider{height:1px;background:var(--border);margin:14px 0}
.warn-box{background:rgba(255,77,109,.07);border:1px solid rgba(255,77,109,.25);border-radius:10px;padding:12px;font-size:12px;color:var(--red);line-height:1.6;margin-bottom:12px}
.info-box{background:rgba(240,185,11,.07);border:1px solid rgba(240,185,11,.25);border-radius:10px;padding:12px;font-size:12px;color:var(--yellow);line-height:1.7;margin-bottom:12px}

.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);border-radius:20px;padding:10px 18px;font-size:13px;font-weight:600;z-index:999;white-space:nowrap;box-shadow:0 8px 32px rgba(0,0,0,.5);animation:tin .2s ease}
@keyframes tin{from{transform:translateX(-50%) translateY(20px);opacity:0}}

.sheet-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:500;align-items:flex-end}
.sheet-ov.show{display:flex}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:20px 20px 0 0;padding:20px 16px 40px;width:100%;animation:sup .2s ease;max-height:90vh;overflow-y:auto}
@keyframes sup{from{transform:translateY(100%)}}
.sh-ttl{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
.sh-x{color:var(--dim);cursor:pointer;font-size:22px;line-height:1}

/* â”€â”€ BALANCE BOX â”€â”€ */
.bal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px}
.bal-box{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center}
.bal-lbl{font-size:9px;letter-spacing:.8px;text-transform:uppercase;color:var(--dim);margin-bottom:4px}
.bal-val{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--accent)}

/* â”€â”€ SETUP STEPS â”€â”€ */
.step{display:flex;gap:12px;margin-bottom:14px;align-items:flex-start}
.step-num{width:26px;height:26px;border-radius:50%;background:rgba(240,185,11,.15);border:1px solid rgba(240,185,11,.35);color:var(--accent);font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.step-text{font-size:12px;line-height:1.6;color:var(--text)}
.step-text strong{color:var(--accent)}
</style>
</head>
<body>

<div class="hdr">
  <div class="logo"><span class="logo-icon">â—ˆ</span>Demo<em>Bot</em></div>
  <div class="hdr-r">
    <div class="badge b-demo">DEMO</div>
    <div class="badge b-off" id="botBadge">STOPPED</div>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="nav('dash')">ğŸ“Š Dash</div>
  <div class="tab" onclick="nav('scanner')">ğŸ” Scan</div>
  <div class="tab" onclick="nav('trades')">ğŸ“‹ Trades</div>
  <div class="tab" onclick="nav('config')">âš™ï¸ Config</div>
  <div class="tab" onclick="nav('setup')">ğŸ”‘ Keys</div>
</div>

<div class="scroll">

<!-- â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â• -->
<div class="page active" id="pg-dash">

  <div class="banner bn-warn" id="connBanner">
    <div class="bn-dot" id="connDot"></div>
    <span id="connText">Enter API keys in the Keys tab to connect</span>
  </div>

  <!-- Ticker -->
  <div class="ticker-wrap">
    <div class="ticker-inner" id="tickerInner">
      <span style="color:var(--dim);font-size:11px;font-family:var(--mono)">Waiting for live pricesâ€¦</span>
    </div>
  </div>

  <!-- Demo Account Balance (from API) -->
  <div class="bal-grid">
    <div class="bal-box"><div class="bal-lbl">Demo Balance</div><div class="bal-val" id="acctBal">â€”</div></div>
    <div class="bal-box"><div class="bal-lbl">Unrealised PnL</div><div class="bal-val" id="acctUpnl" style="color:var(--green)">â€”</div></div>
    <div class="bal-box"><div class="bal-lbl">Margin Used</div><div class="bal-val" id="acctMargin">â€”</div></div>
  </div>

  <!-- Stats -->
  <div class="sg">
    <div class="sb la"><div class="sl">Session Capital</div><div class="sv a" id="s-cap">$900.00</div><div class="ss">Started: $900</div></div>
    <div class="sb lg"><div class="sl">Session P&L</div><div class="sv g" id="s-pnl">+$0.00</div><div class="ss" id="s-pct">0.00%</div></div>
    <div class="sb ly"><div class="sl">Trades</div><div class="sv y" id="s-trades">0 / 20</div><div class="ss">demo orders</div></div>
    <div class="sb lg"><div class="sl">Win Rate</div><div class="sv g" id="s-wr">â€”</div><div class="ss" id="s-wl">0W / 0L</div></div>
  </div>

  <!-- P&L Chart -->
  <div class="card">
    <div class="chdr"><div class="ct">P&L Curve</div><div class="ca" onclick="resetSession()">Reset</div></div>
    <canvas class="pnl" id="pnlChart"></canvas>
  </div>

  <!-- Progress -->
  <div class="card">
    <div class="ct" style="margin-bottom:10px">Daily Goals</div>
    <div class="pw"><div class="pm"><span>Profit Target ($200)</span><span id="p1t">$0</span></div><div class="pb"><div class="pf" id="p1" style="width:0%;background:var(--green)"></div></div></div>
    <div class="pw"><div class="pm"><span>Trades (20)</span><span id="p2t">0/20</span></div><div class="pb"><div class="pf" id="p2" style="width:0%;background:var(--accent)"></div></div></div>
    <div class="pw"><div class="pm"><span>Loss Guard ($80 max)</span><span id="p3t">$0</span></div><div class="pb"><div class="pf" id="p3" style="width:0%;background:var(--red)"></div></div></div>
  </div>

  <!-- Open Positions -->
  <div class="card">
    <div class="chdr"><div class="ct">Open Positions</div><div class="ca" id="posCount">0 open</div></div>
    <div id="openPos"><div class="empty"><div class="ei">ğŸ“­</div>No open positions</div></div>
  </div>

  <button class="btn btn-y" id="mainBtn" onclick="toggleBot()">â–¶ START DEMO BOT</button>

  <!-- BOT LOG -->
  <div style="margin-top:16px;padding-bottom:20px">
    <div style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--dim);margin-bottom:8px">ğŸ“‹ Bot Activity Log</div>
    <div id="logBox" style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px;height:220px;overflow-y:auto;font-family:var(--mono);font-size:10px;line-height:1.9;-webkit-overflow-scrolling:touch;"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
      <button class="btn btn-ghost" style="font-size:12px;padding:10px" onclick="document.getElementById('logBox').innerHTML=''">Clear Log</button>
      <button class="btn btn-ghost" style="font-size:12px;padding:10px" onclick="forceScan()">â–¶ Force Scan</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• SCANNER â•â•â•â•â•â•â•â• -->
<div class="page" id="pg-scanner">
  <div class="card">
    <div class="chdr"><div class="ct">Live Signal Scanner</div><div class="ca" onclick="runScan()">â†» Scan</div></div>
    <div class="fr" style="margin-bottom:10px">
      <input class="fi" id="symSearch" placeholder="ğŸ” Search symbol (e.g. BTC, ETH, SOL)" oninput="runScan()" style="font-size:13px">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px">
      <button class="btn btn-ghost" style="font-size:11px;padding:8px" onclick="loadTopGainers().then(()=>runScan())">ğŸ”¥ Top Gainers</button>
      <button class="btn btn-ghost" style="font-size:11px;padding:8px" onclick="loadTopLosers().then(()=>runScan())">ğŸ“‰ Top Losers</button>
    </div>
    <div class="fr">
      <select class="fs" id="scanStrat" onchange="runScan()">
        <option value="rsi">RSI Reversal</option>
        <option value="ema">EMA Crossover (9/21)</option>
        <option value="vol">Volume Spike</option>
        <option value="break">Breakout</option>
        <option value="macd">MACD Signal</option>
      </select>
    </div>
    <div id="scanList"><div class="empty"><div class="ei">ğŸ”</div>Connect API keys then tap Scan</div></div>
  </div>

  <div class="card">
    <div class="ct" style="margin-bottom:12px">Manual Demo Order</div>
    <div class="fr">
      <label class="fl">Symbol</label>
      <select class="fs" id="manSym">
        <option>BTCUSDT</option><option>ETHUSDT</option><option>BNBUSDT</option>
        <option>SOLUSDT</option><option>XRPUSDT</option><option>DOGEUSDT</option>
        <option>ADAUSDT</option><option>AVAXUSDT</option><option>MATICUSDT</option>
        <option>LINKUSDT</option><option>DOTUSDT</option><option>LTCUSDT</option>
      </select>
    </div>
    <div class="f2">
      <div class="fr"><label class="fl">Size ($)</label><input class="fi" id="manSize" type="number" value="45"></div>
      <div class="fr"><label class="fl">Leverage</label><input class="fi" id="manLev" type="number" value="5"></div>
    </div>
    <div class="b2">
      <button class="btn btn-g" onclick="manualOrder('BUY')">â–² LONG</button>
      <button class="btn btn-r" onclick="manualOrder('SELL')">â–¼ SHORT</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• TRADES â•â•â•â•â•â•â•â• -->
<div class="page" id="pg-trades">
  <div class="sg">
    <div class="sb la"><div class="sl">Total Trades</div><div class="sv a" id="t-total">0</div></div>
    <div class="sb lg"><div class="sl">Total P&L</div><div class="sv g" id="t-pnl">$0.00</div></div>
    <div class="sb lg"><div class="sl">Best Trade</div><div class="sv g" id="t-best">â€”</div></div>
    <div class="sb lr"><div class="sl">Worst Trade</div><div class="sv r" id="t-worst">â€”</div></div>
  </div>
  <div class="card">
    <div class="chdr"><div class="ct">Trade History</div><div class="ca" onclick="clearHistory()">Clear</div></div>
    <div id="tradeList"><div class="empty"><div class="ei">ğŸ“‹</div>No trades yet</div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• CONFIG â•â•â•â•â•â•â•â• -->
<div class="page" id="pg-config">
  <div class="card">
    <div class="ct" style="margin-bottom:12px">Strategy</div>
    <div class="fr"><label class="fl">Strategy</label>
      <select class="fs" id="cfgStrat">
        <option value="rsi">RSI Reversal (RSI &lt;30 / &gt;70)</option>
        <option value="ema">EMA Crossover (9/21)</option>
        <option value="vol">Volume Spike</option>
        <option value="break">Breakout (20-bar H/L)</option>
        <option value="macd">MACD Signal</option>
        <option value="mixed">Mixed (rotates all)</option>
      </select>
    </div>
    <div class="f2">
      <div class="fr"><label class="fl">Trade Size ($)</label><input class="fi" id="cfgSize" type="number" value="45"></div>
      <div class="fr"><label class="fl">Leverage</label><input class="fi" id="cfgLev" type="number" value="5" min="1" max="20"></div>
    </div>
    <div class="f2">
      <div class="fr"><label class="fl">Take Profit ($)</label><input class="fi" id="cfgTP" type="number" value="10"></div>
      <div class="fr"><label class="fl">Stop Loss ($)</label><input class="fi" id="cfgSL" type="number" value="8"></div>
    </div>
    <div class="f2">
      <div class="fr"><label class="fl">Max Trades/Day</label><input class="fi" id="cfgMaxT" type="number" value="20"></div>
      <div class="fr"><label class="fl">Max Open</label><input class="fi" id="cfgMaxP" type="number" value="3"></div>
    </div>
  </div>
  <div class="card">
    <div class="ct" style="margin-bottom:10px">Risk Controls</div>
    <div class="trow"><div><div class="tn">Daily Loss Guard</div><div class="td">Stop if daily loss > $80</div></div><div class="tog on" id="tog-dlg" onclick="togSet('dlg')"></div></div>
    <div class="trow"><div><div class="tn">Auto TP/SL Orders</div><div class="td">Place TP & SL on Binance Demo</div></div><div class="tog on" id="tog-tpsl" onclick="togSet('tpsl')"></div></div>
    <div class="trow"><div><div class="tn">Auto-Trade Signals</div><div class="td">Bot places demo orders automatically</div></div><div class="tog on" id="tog-auto" onclick="togSet('auto')"></div></div>
    <div class="trow"><div><div class="tn">Realistic Slippage</div><div class="td">Simulate 0.05% slippage</div></div><div class="tog on" id="tog-slip" onclick="togSet('slip')"></div></div>
  </div>
  <button class="btn btn-y" onclick="saveConfig()">Save Configuration</button>
</div>

<!-- â•â•â•â•â•â•â•â• SETUP / KEYS â•â•â•â•â•â•â•â• -->
<div class="page" id="pg-setup">

  <div class="info-box">
    âš ï¸ Keys are stored <strong>only in your browser</strong> on this device. They are never sent anywhere except directly to demo-fapi.binance.com.
  </div>

  <div class="card">
    <div class="ct" style="margin-bottom:14px">ğŸ”‘ Binance Demo API Keys</div>

    <div class="fr">
      <label class="fl">API Key</label>
      <div class="eye-wrap">
        <input class="fi pw-field" id="apiKey" type="password" placeholder="Paste your Demo API Key" autocomplete="off">
        <button class="eye-btn" onclick="toggleEye('apiKey',this)">ğŸ‘</button>
      </div>
    </div>
    <div class="fr">
      <label class="fl">Secret Key</label>
      <div class="eye-wrap">
        <input class="fi pw-field" id="apiSecret" type="password" placeholder="Paste your Demo Secret Key" autocomplete="off">
        <button class="eye-btn" onclick="toggleEye('apiSecret',this)">ğŸ‘</button>
      </div>
    </div>

    <button class="btn btn-y" onclick="connectAPI()" id="connectBtn">Connect to Binance Demo</button>

    <div id="connectResult" style="margin-top:12px;font-size:12px;text-align:center;color:var(--dim)"></div>
  </div>

  <div class="card">
    <div class="ct" style="margin-bottom:12px">ğŸ“‹ How to get your Demo API Keys</div>
    <div class="step"><div class="step-num">1</div><div class="step-text">Go to <strong>demo.binance.com</strong> on your phone</div></div>
    <div class="step"><div class="step-num">2</div><div class="step-text">Tap the menu â†’ <strong>API Management</strong></div></div>
    <div class="step"><div class="step-num">3</div><div class="step-text">Tap <strong>Create API</strong> â†’ System Generated â†’ name it <strong>demobot</strong></div></div>
    <div class="step"><div class="step-num">4</div><div class="step-text">Enable <strong>Futures Trading</strong> permission only</div></div>
    <div class="step"><div class="step-num">5</div><div class="step-text">Copy <strong>API Key</strong> and <strong>Secret Key</strong> â€” paste them above</div></div>

    <div class="divider"></div>
    <div class="warn-box">ğŸ”’ Never share your real Binance API keys with anyone. Demo keys only work on demo.binance.com â€” safe to use here.</div>
  </div>

  <div class="card">
    <div class="ct" style="margin-bottom:10px">Connection Status</div>
    <div id="apiStatus" style="font-family:var(--mono);font-size:11px;line-height:2;color:var(--dim)">Not connected yet.</div>
  </div>
</div>

</div><!-- /scroll -->

<!-- Sheet -->
<div class="sheet-ov" id="sheet">
  <div class="sheet">
    <div class="sh-ttl"><span id="sh-title">â€”</span><span class="sh-x" onclick="closeSheet()">Ã—</span></div>
    <div id="sh-body"></div>
  </div>
</div>

<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  BINANCE DEMO TRADING BOT                                   â•‘
// â•‘  API: https://demo-fapi.binance.com  (official demo)        â•‘
// â•‘  Prices: wss://stream.binance.com (public WebSocket)        â•‘
// â•‘  Orders: REAL demo orders on your Binance Demo account      â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DEMO_API  = 'https://demo-fapi.binance.com';
const WS_STREAM = 'wss://stream.binance.com:9443/stream';

// Base symbols â€” expanded to 30 coins
let SYMBOLS = [
  'BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT',
  'DOGEUSDT','ADAUSDT','AVAXUSDT','MATICUSDT','LINKUSDT',
  'DOTUSDT','LTCUSDT','SHIBUSDT','TRXUSDT','NEARUSDT',
  'ATOMUSDT','UNIUSDT','FTMUSDT','SANDUSDT','MANAUSDT',
  'ALGOUSDT','VETUSDT','ICPUSDT','FILUSDT','AAVEUSDT',
  'GRTUSDT','MKRUSDT','SNXUSDT','CRVUSDT','1INCHUSDT'
];
const ICONS = {
  BTCUSDT:'â‚¿',ETHUSDT:'Î',BNBUSDT:'B',SOLUSDT:'â—',XRPUSDT:'âœ•',
  DOGEUSDT:'Ã',ADAUSDT:'â‚³',AVAXUSDT:'A',MATICUSDT:'M',LINKUSDT:'â¬¡',
  DOTUSDT:'â—',LTCUSDT:'Å',SHIBUSDT:'ğŸ•',TRXUSDT:'T',NEARUSDT:'N',
  ATOMUSDT:'âš›',UNIUSDT:'ğŸ¦„',FTMUSDT:'F',SANDUSDT:'S',MANAUSDT:'M',
  ALGOUSDT:'A',VETUSDT:'V',ICPUSDT:'I',FILUSDT:'F',AAVEUSDT:'A',
  GRTUSDT:'G',MKRUSDT:'M',SNXUSDT:'S',CRVUSDT:'C','1INCHUSDT':'1'
};

// Fetch top gainers from Binance and add to scan list
async function loadTopGainers() {
  try {
    const r = await fetch('https://api.binance.com/api/v3/ticker/24hr');
    const all = await r.json();
    const futures = all
      .filter(t=>t.symbol.endsWith('USDT') && !t.symbol.includes('_') && parseFloat(t.quoteVolume)>50000000)
      .sort((a,b)=>parseFloat(b.priceChangePercent)-parseFloat(a.priceChangePercent))
      .slice(0,20)
      .map(t=>t.symbol);
    // Merge with base list, deduplicate
    const merged = [...new Set([...futures,...SYMBOLS])].slice(0,40);
    SYMBOLS = merged;
    log('ğŸ”¥ Top gainers loaded: '+futures.slice(0,5).join(', ')+'â€¦','ok');
  } catch(e){ log('Top gainers fetch failed: '+e.message,'warn'); }
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const st = {
  running: false,
  connected: false,
  apiKey: '', apiSecret: '',

  // Market data (from public WebSocket â€” no CORS)
  prices: {}, change24h: {}, candles: {}, wsReady: {},
  wsTicks: 0,

  // Session tracking
  capital: 900, todayPnl: 0, totalPnl: 0, todayLoss: 0,
  tradeCount: 0, wins: 0, losses: 0,
  openPos: [], allTrades: [], pnlHistory: [0],

  ws: null, wsKlines: {},
  loopInterval: null, monitorInterval: null, balanceInterval: null,
  tickStep: 0,

  cfg: { strategy:'rsi', size:45, leverage:5, tp:10, sl:8, maxTrades:20, maxOpen:3 },
  togs: { dlg:true, tpsl:true, auto:true, slip:true }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HMAC-SHA256 SIGNING (Web Crypto API â€” works in mobile browsers)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sign(secret, message) {
  const enc = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw', enc.encode(secret),
    { name:'HMAC', hash:'SHA-256' }, false, ['sign']
  );
  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(message));
  return Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BINANCE DEMO API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function demoGET(path, params={}) {
  try {
    params.timestamp = Date.now();
    const qs  = new URLSearchParams(params).toString();
    const sig = await sign(st.apiSecret, qs);
    const fullUrl = `${DEMO_API}${path}?${qs}&signature=${sig}`;
    // Try direct first
    try {
      const res = await fetch(fullUrl, {headers:{'X-MBX-APIKEY':st.apiKey},signal:AbortSignal.timeout(6000)});
      const data = await res.json();
      if (data.code && data.code < 0) throw new Error(data.msg);
      return data;
    } catch(e) {}
    // Fallback to proxy
    if (!activeProxy) await findProxy();
    if (!activeProxy) return null;
    const res2 = await fetch(activeProxy + encodeURIComponent(fullUrl), {headers:{'X-MBX-APIKEY':st.apiKey},signal:AbortSignal.timeout(8000)});
    const data2 = await res2.json();
    if (data2.code && data2.code < 0) throw new Error(data2.msg);
    return data2;
  } catch(e) {
    log('GET '+path+' error: '+e.message,'err');
    return null;
  }
}

// CORS proxies â€” tried in order until one works
const PROXIES = [
  'https://corsproxy.io/?',
  'https://api.allorigins.win/raw?url=',
  'https://proxy.cors.sh/',
];
let activeProxy = null;

async function findProxy() {
  for (const p of PROXIES) {
    try {
      const url = p + encodeURIComponent('https://demo-fapi.binance.com/fapi/v1/time');
      const r = await fetch(url, {signal:AbortSignal.timeout(4000)});
      if (r.ok || r.status===400) { activeProxy=p; log('âœ… Proxy: '+p.split('/')[2],'ok'); return p; }
    } catch(e){}
  }
  log('âš ï¸ All proxies failed â€” POST orders may not work','warn');
  return null;
}

async function demoPOST(path, params={}) {
  try {
    params.timestamp = Date.now();
    const qs  = new URLSearchParams(params).toString();
    const sig = await sign(st.apiSecret, qs);
    const body = qs + '&signature=' + sig;

    // Try direct POST first (works if CORS headers set by server)
    try {
      const res = await fetch(`${DEMO_API}${path}`, {
        method: 'POST',
        headers: {'X-MBX-APIKEY': st.apiKey, 'Content-Type': 'application/x-www-form-urlencoded'},
        body,
        signal: AbortSignal.timeout(8000)
      });
      const data = await res.json();
      if (data.code && data.code < 0) throw new Error(data.msg);
      log('âœ… Direct POST success: '+path,'ok');
      return data;
    } catch(e) {
      log('Direct POST blocked (CORS) â€” trying proxyâ€¦','warn');
    }

    // Fallback: proxy POST
    if (!activeProxy) await findProxy();
    if (!activeProxy) { log('No working proxy for POST','err'); return null; }

    const proxyUrl = activeProxy + encodeURIComponent(`${DEMO_API}${path}`);
    const res2 = await fetch(proxyUrl, {
      method: 'POST',
      headers: {'X-MBX-APIKEY': st.apiKey, 'Content-Type': 'application/x-www-form-urlencoded'},
      body,
      signal: AbortSignal.timeout(8000)
    });
    const data2 = await res2.json();
    if (data2.code && data2.code < 0) throw new Error(data2.msg);
    log('âœ… Proxy POST success: '+path,'ok');
    return data2;

  } catch(e) {
    log('POST error '+path+': '+e.message,'err');
    return null;
  }
}

// â”€â”€ TEST CONNECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function connectAPI() {
  const key    = document.getElementById('apiKey').value.trim();
  const secret = document.getElementById('apiSecret').value.trim();

  if (!key || !secret) { toast('Enter both API Key and Secret Key'); return; }
  if (key.length < 20 || secret.length < 20) { toast('Keys look too short â€” check them'); return; }

  st.apiKey    = key;
  st.apiSecret = secret;

  document.getElementById('connectBtn').textContent = 'Connectingâ€¦';
  document.getElementById('connectResult').textContent = 'Testing connection to demo-fapi.binance.comâ€¦';

  // Find working CORS proxy for POST orders
  findProxy();

  // Test with account balance endpoint
  const bal = await fetchBalance();
  if (bal) {
    st.connected = true;
    setBanner('ok', 'ğŸŸ¢ Connected to Binance Demo Trading');
    document.getElementById('connectBtn').textContent = 'âœ“ Connected';
    document.getElementById('connectBtn').className   = 'btn btn-ghost';
    document.getElementById('connectResult').style.color = 'var(--green)';
    document.getElementById('connectResult').textContent = 'âœ… Successfully connected to demo-fapi.binance.com';
    log('âœ… Connected to Binance Demo API (demo-fapi.binance.com)', 'ok');

    // Save to localStorage (persists across reloads â€” fixes auto-logout)
    localStorage.setItem('demoKey',    key);
    localStorage.setItem('demoSecret', secret);
    localStorage.setItem('demoProxy', activeProxy||'');

    updateAPIStatus();
    startPriceStream();
    startBalancePolling();
    toast('Connected to Binance Demo! âœ“');
  } else {
    st.connected = false;
    document.getElementById('connectBtn').textContent = 'Retry Connection';
    document.getElementById('connectResult').style.color = 'var(--red)';
    document.getElementById('connectResult').textContent = 'âŒ Connection failed â€” check your keys';
    log('âŒ Connection failed. Check API key and secret.', 'err');
    setBanner('err', 'âŒ Cannot connect â€” check your API keys in the Keys tab');
  }
}

async function fetchBalance() {
  const data = await demoGET('/fapi/v2/account');
  if (!data || !data.assets) return null;

  const usdt = data.assets.find(a => a.asset === 'USDT');
  if (usdt) {
    setText('acctBal',    `$${parseFloat(usdt.walletBalance).toFixed(2)}`);
    setText('acctUpnl',   `${parseFloat(usdt.unrealizedProfit)>=0?'+':''}$${parseFloat(usdt.unrealizedProfit).toFixed(2)}`);
    setText('acctMargin', `$${parseFloat(usdt.initialMargin).toFixed(2)}`);
    document.getElementById('acctUpnl').style.color =
      parseFloat(usdt.unrealizedProfit) >= 0 ? 'var(--green)' : 'var(--red)';
  }
  return data;
}

function startBalancePolling() {
  clearInterval(st.balanceInterval);
  st.balanceInterval = setInterval(fetchBalance, 15_000);
}

function updateAPIStatus() {
  document.getElementById('apiStatus').textContent =
`Status:    Connected âœ“
Endpoint:  demo-fapi.binance.com
API Key:   ${st.apiKey.substring(0,8)}â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢
Strategy:  ${st.cfg.strategy.toUpperCase()}
Leverage:  ${st.cfg.leverage}x
Trade Size:$${st.cfg.size}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET PRICE STREAMS (public â€” no auth needed, no CORS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPriceStream() {
  // Combined mini-ticker + kline streams
  connectTickerWS();
  SYMBOLS.forEach(sym => connectKlineWS(sym));
  log('ğŸ“¡ WebSocket price streams opened', 'info');
}

function connectTickerWS() {
  const streams = SYMBOLS.map(s => s.toLowerCase() + '@miniTicker').join('/');
  const ws = new WebSocket(`${WS_STREAM}?streams=${streams}`);

  ws.onopen = () => {
    log('ğŸ“ˆ Live prices connected','ok');
    // Load historical candles immediately
    (async()=>{
      log('ğŸ“¥ Loading 500 candles per symbolâ€¦','info');
      let done=0;
      for(const sym of SYMBOLS){
        try{
          const r=await fetch('https://api.binance.com/api/v3/klines?symbol='+sym+'&interval=5m&limit=500');
          const d=await r.json();
          if(Array.isArray(d)){
            st.candles[sym]=d.map(k=>({open:+k[1],high:+k[2],low:+k[3],close:+k[4],vol:+k[5],closed:true}));
            st.wsReady[sym]=true; done++;
          }
        }catch(e){log('âš ï¸ '+sym+': '+e.message,'warn');}
        await new Promise(r=>setTimeout(r,80));
      }
      log('âœ… '+done+' symbols ready â€” scanning now!','ok');
      if(st.connected) setBanner('ok','ğŸŸ¢ Connected to Binance Demo â€” '+done+' symbols loaded!');
      loadTopGainers().then(()=>runScan());
      if(st.running) botLoop();
    })();
  };
  ws.onmessage = e => {
    try {
      const d = JSON.parse(e.data).data;
      if (!d?.s || !SYMBOLS.includes(d.s)) return;
      st.prices[d.s]    = parseFloat(d.c);
      st.change24h[d.s] = parseFloat(d.P);
      st.wsTicks++;
      setText('ws-ticks', st.wsTicks);
      updateTicker();
      if (st.running) { monitorOpenPositions(); renderOpenPos(); }
    } catch(e){}
  };
  ws.onerror = () => {};
  ws.onclose = () => { setTimeout(connectTickerWS, 5000); };
  st.ws = ws;
}

function connectKlineWS(sym) {
  const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@kline_5m`);
  ws.onmessage = e => {
    try {
      const k = JSON.parse(e.data).k;
      if (!k) return;
      const candle = { open:parseFloat(k.o), high:parseFloat(k.h), low:parseFloat(k.l), close:parseFloat(k.c), vol:parseFloat(k.v), closed:k.x };
      if (!st.candles[sym]) st.candles[sym] = [];
      if (candle.closed) {
        st.candles[sym].push(candle);
        if (st.candles[sym].length > 100) st.candles[sym].shift();
        st.wsReady[sym] = st.candles[sym].length >= 20;
      } else {
        const arr = st.candles[sym];
        if (arr.length > 0) arr[arr.length-1] = candle; else arr.push(candle);
      }
    } catch(e){}
  };
  ws.onerror = () => {};
  ws.onclose = () => { setTimeout(() => connectKlineWS(sym), 5000); };
  st.wsKlines[sym] = ws;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rsi(candles, p=14) {
  if (candles.length < p+1) return 50;
  let g=0,l=0;
  for (let i=candles.length-p; i<candles.length; i++) {
    const d=candles[i].close-candles[i-1].close;
    if(d>0) g+=d; else l-=d;
  }
  return 100-100/(1+g/(l||.0001));
}
function ema(arr,n){ const k=2/(n+1);let e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e; }
function macd(c){ const cl=c.map(x=>x.close); return cl.length>=26?ema(cl,12)-ema(cl,26):0; }
function volSpike(c){ if(c.length<11)return 1; const v=c.slice(-11).map(x=>x.vol),avg=v.slice(0,-1).reduce((a,b)=>a+b,0)/10; return v[v.length-1]/(avg||1); }

// â”€â”€ ADVANCED INDICATORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stoch(c,k=14,d=3){
  if(c.length<k) return{k:50,d:50};
  const hi=Math.max(...c.slice(-k).map(x=>x.high));
  const lo=Math.min(...c.slice(-k).map(x=>x.low));
  const kv=((c[c.length-1].close-lo)/(hi-lo||1))*100;
  return{k:kv,d:kv}; // simplified
}
function atr(c,p=14){
  if(c.length<p+1) return 0;
  let sum=0;
  for(let i=c.length-p;i<c.length;i++){
    const h=c[i].high,l=c[i].low,pc=c[i-1].close;
    sum+=Math.max(h-l,Math.abs(h-pc),Math.abs(l-pc));
  }
  return sum/p;
}
// â”€â”€ DYNAMIC LEVERAGE BASED ON VOLATILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ATR% = ATR/price â€” measures how volatile the coin is right now
// High volatility (wild altcoins) â†’ low leverage to avoid liquidation
// Low volatility (BTC, ETH trending) â†’ high leverage to maximise returns
function getDynamicLeverage(sym) {
  const c = st.candles[sym];
  const price = st.prices[sym];
  if (!c || c.length < 20 || !price) return st.cfg.leverage;

  const atrVal = atr(c, 14);
  const atrPct = (atrVal / price) * 100; // ATR as % of price

  // Volatility tiers:
  // Very low  < 0.3%  â†’ 20x (BTC/ETH in calm market)
  // Low       0.3-0.6% â†’ 15x
  // Medium    0.6-1.2% â†’ 10x
  // High      1.2-2.5% â†’ 6x
  // Very high 2.5-5%  â†’ 4x
  // Extreme   > 5%    â†’ 3x (meme coins, small caps)
  let lev;
  if      (atrPct < 0.3)  lev = 20;
  else if (atrPct < 0.6)  lev = 15;
  else if (atrPct < 1.2)  lev = 10;
  else if (atrPct < 2.5)  lev = 6;
  else if (atrPct < 5.0)  lev = 4;
  else                     lev = 3;

  // Cap at user's configured max leverage
  lev = Math.min(lev, st.cfg.leverage);

  log('âš¡ '+sym+' ATR%='+atrPct.toFixed(2)+'% â†’ '+lev+'x leverage','info');
  return lev;
}

function bollingerBands(cl,p=20,mult=2){
  if(cl.length<p) return{upper:cl[cl.length-1],lower:cl[cl.length-1],mid:cl[cl.length-1]};
  const slice=cl.slice(-p);
  const mid=slice.reduce((a,b)=>a+b,0)/p;
  const std=Math.sqrt(slice.reduce((a,b)=>a+(b-mid)**2,0)/p);
  return{upper:mid+mult*std,lower:mid-mult*std,mid};
}
function ema50(cl){ return ema(cl,50); }

// â”€â”€ HIGH-PROBABILITY SIGNAL ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Requires 3+ confluences to fire â€” much higher win rate
function getSignal(sym) {
  const c=st.candles[sym]; if(!c||c.length<50) return null;
  const cl=c.map(x=>x.close), cur=cl[cl.length-1];
  const prev=cl[cl.length-2], prev2=cl[cl.length-3];
  try {
    // Core indicators
    const r14   = rsi(c,14);
    const r7    = rsi(c,7);  // faster RSI
    const e9    = ema(cl,9);
    const e21   = ema(cl,21);
    const e50   = ema(cl.slice(-60),50);
    const m     = macd(c);
    const vs    = volSpike(c);
    const bb    = bollingerBands(cl);
    const atrV  = atr(c,14);
    const st2   = stoch(c);
    const mom5  = cur - cl[cl.length-6];  // 5-candle momentum
    const mom3  = cur - cl[cl.length-4];  // 3-candle momentum

    // â”€â”€ CONFLUENCE SCORING â”€â”€
    // Each check is a high-quality signal â€” need 3+ for trade
    let bullSignals=[], bearSignals=[];

    // 1. RSI conditions
    if(r14<35 && r7<30) bullSignals.push('RSI oversold('+r14.toFixed(0)+')');
    if(r14>65 && r7>70) bearSignals.push('RSI overbought('+r14.toFixed(0)+')');
    if(r14>45 && r14<60 && r7>r14) bullSignals.push('RSI bullish momentum');
    if(r14>40 && r14<55 && r7<r14) bearSignals.push('RSI bearish momentum');

    // 2. EMA trend alignment
    if(e9>e21 && e21>e50 && cur>e9) bullSignals.push('EMA aligned bull');
    if(e9<e21 && e21<e50 && cur<e9) bearSignals.push('EMA aligned bear');
    if(e9>e21 && cur>e21) bullSignals.push('EMA9>EMA21');
    if(e9<e21 && cur<e21) bearSignals.push('EMA9<EMA21');

    // 3. MACD
    if(m>0 && m>macd({candles:c.slice(0,-1),map:x=>x})) bullSignals.push('MACD+ rising');
    if(m<0) bearSignals.push('MACD negative');
    if(m>0) bullSignals.push('MACD positive');

    // 4. Bollinger Bands
    if(cur<bb.lower*1.002) bullSignals.push('BB oversold bounce');
    if(cur>bb.upper*0.998) bearSignals.push('BB overbought');
    if(cur>bb.mid && prev<bb.mid) bullSignals.push('BB midline cross up');
    if(cur<bb.mid && prev>bb.mid) bearSignals.push('BB midline cross down');

    // 5. Volume confirmation
    if(vs>2.0 && cur>prev) bullSignals.push('High vol bull candle('+vs.toFixed(1)+'x)');
    if(vs>2.0 && cur<prev) bearSignals.push('High vol bear candle('+vs.toFixed(1)+'x)');
    if(vs>1.3 && cur>prev) bullSignals.push('Vol confirmed up');
    if(vs>1.3 && cur<prev) bearSignals.push('Vol confirmed down');

    // 6. Momentum
    if(mom5>0 && mom3>0 && cur>prev) bullSignals.push('Strong momentum up');
    if(mom5<0 && mom3<0 && cur<prev) bearSignals.push('Strong momentum down');

    // 7. Candlestick patterns
    const body=Math.abs(cur-c[c.length-1].open);
    const range=c[c.length-1].high-c[c.length-1].low;
    if(body>range*0.6 && cur>c[c.length-1].open) bullSignals.push('Bull candle body');
    if(body>range*0.6 && cur<c[c.length-1].open) bearSignals.push('Bear candle body');

    // 8. Price action vs 50 EMA
    if(cur>e50 && prev2<e50) bullSignals.push('50EMA breakout');
    if(cur<e50 && prev2>e50) bearSignals.push('50EMA breakdown');

    // â”€â”€ DECISION: need minimum 3 confluences â”€â”€
    const minConf = 3;
    if(bullSignals.length>=minConf && bullSignals.length>bearSignals.length+1){
      const conf=Math.min(50+bullSignals.length*6,95);
      return{dir:'LONG', conf, reason:bullSignals.slice(0,3).join(' | '), signals:bullSignals.length, atrPct:(atrV/cur*100)};
    }
    if(bearSignals.length>=minConf && bearSignals.length>bullSignals.length+1){
      const conf=Math.min(50+bearSignals.length*6,95);
      return{dir:'SHORT', conf, reason:bearSignals.slice(0,3).join(' | '), signals:bearSignals.length, atrPct:(atrV/cur*100)};
    }
    // Weak signal â€” only show in scanner, don't auto-trade
    if(bullSignals.length>bearSignals.length)
      return{dir:'LONG', conf:40+bullSignals.length*4, reason:'Weak: '+bullSignals.slice(0,2).join(', '), signals:bullSignals.length, weak:true};
    if(bearSignals.length>bullSignals.length)
      return{dir:'SHORT', conf:40+bearSignals.length*4, reason:'Weak: '+bearSignals.slice(0,2).join(', '), signals:bearSignals.length, weak:true};
    return null;
  } catch(e){ return null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORDER PLACEMENT ON BINANCE DEMO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function setLeverage(sym, lev) {
  return await demoPOST('/fapi/v1/leverage', { symbol:sym, leverage:lev });
}

async function placeOrder(sym, dir, size) {
  if (!st.connected) { toast('Not connected to Binance Demo'); return; }
  if (st.tradeCount >= st.cfg.maxTrades) { toast('Daily trade limit reached'); return; }
  if (st.togs.dlg && st.todayLoss >= 80) { toast('Daily loss limit hit'); return; }

  const price = st.prices[sym];
  if (!price) { log(`No live price for ${sym}`, 'warn'); return; }

  const slip     = st.togs.slip ? 0.0005 : 0;
  const entry    = price * (dir==='BUY' ? 1+slip : 1-slip);
  const lev      = getDynamicLeverage(sym);  // Dynamic: ATR-based volatility leverage
  const notional = size * lev;
  const tpDist   = st.cfg.tp / notional;
  const slDist   = st.cfg.sl / notional;
  const tpPrice  = dir==='BUY' ? entry*(1+tpDist) : entry*(1-tpDist);
  const slPrice  = dir==='BUY' ? entry*(1-slDist) : entry*(1+slDist);

  // Set leverage first
  await setLeverage(sym, lev);

  // Calculate quantity
  const decimals = entry >= 1000 ? 3 : entry >= 100 ? 2 : entry >= 1 ? 1 : 0;
  const qty = parseFloat((notional / entry).toFixed(decimals));

  log('ğŸ“¤ '+dir+' '+qty+' '+sym+' @ ~$'+fmt(entry)+' | '+lev+'x | TP $'+fmt(tpPrice)+' | SL $'+fmt(slPrice), 'info');

  // Place market order on demo-fapi
  const order = await demoPOST('/fapi/v1/order', {
    symbol: sym, side: dir,
    type: 'MARKET', quantity: qty,
    positionSide: 'BOTH'
  });

  if (!order || !order.orderId) {
    log(`âŒ Order failed for ${sym}`, 'err');
    return;
  }

  log(`âœ… DEMO ORDER FILLED: ${order.side} ${order.origQty} ${sym} | OrderID: ${order.orderId}`, 'ok');

  // TP/SL â€” monitored locally (demo API doesn't support conditional order types)
  log('ğŸ¯ TP @ $'+fmt(tpPrice)+' | SL @ $'+fmt(slPrice)+' (local monitor active)', 'ok');

  // Track locally
  const trade = {
    id: order.orderId, sym, dir,
    size, lev, price: entry, notional,
    tpPrice, slPrice,
    qty, orderId: order.orderId,
    reason: `Demo order #${order.orderId}`,
    time: new Date().toLocaleTimeString(),
    status: 'OPEN', pnl: 0
  };
  st.openPos.push(trade);
  st.allTrades.unshift(trade);
  st.tradeCount++;
  st.capital -= size;

  updateDash(); renderOpenPos();
  toast(`Demo ${dir==='BUY'?'LONG':'SHORT'} placed on Binance!`);
}

async function closePosition(trade) {
  // Close via market order (opposite side)
  const closeSide = trade.dir==='BUY' ? 'SELL' : 'BUY';
  const order = await demoPOST('/fapi/v1/order', {
    symbol: trade.sym, side: closeSide,
    type: 'MARKET', quantity: trade.qty,
    reduceOnly: 'true'
  });
  if (order?.orderId) {
    const cur = st.prices[trade.sym] || trade.price;
    const pd  = (cur - trade.price) / trade.price;
    const pnl = trade.dir==='BUY' ? trade.notional*pd : -trade.notional*pd;
    recordClose(trade, pnl, 'Manual close');
    log(`ğŸ”’ Position closed on Binance Demo | PnL: ${pnl>=0?'+':''}$${pnl.toFixed(2)}`, pnl>=0?'ok':'warn');
  }
}

function recordClose(trade, pnl, reason) {
  st.openPos = st.openPos.filter(t=>t.id!==trade.id);
  trade.status = pnl>=0?'WIN':'LOSS'; trade.pnl = pnl;
  st.capital += trade.size + pnl;
  st.todayPnl += pnl; st.totalPnl += pnl;
  if(pnl>=0) st.wins++; else { st.losses++; st.todayLoss+=Math.abs(pnl); }
  st.pnlHistory.push(st.totalPnl);
  log(`${pnl>=0?'ğŸ’°':'ğŸ”´'} CLOSED ${trade.sym}: ${pnl>=0?'+':''}$${pnl.toFixed(2)} | ${reason}`, pnl>=0?'ok':'err');
  updateDash(); renderTrades();
}

function monitorOpenPositions() {
  // Monitor locally tracked positions for TP/SL
  // (Binance Demo will also auto-close via server-side TP/SL orders)
  for (const t of [...st.openPos]) {
    const cur = st.prices[t.sym];
    if (!cur) continue;
    const pd  = (cur - t.price) / t.price;
    const pnl = t.dir==='BUY' ? t.notional*pd : -t.notional*pd;
    t.pnl = pnl;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOT LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function botLoop() {
  if (!st.running) return;
  st.tickStep++;

  if (!st.connected)                               { log('Not connected to Binance Demo','warn'); return; }
  if (st.tradeCount >= st.cfg.maxTrades)           { log('Daily trade limit reached','warn'); return; }
  if (st.togs.dlg && st.todayLoss >= 80)          { log('â›” Daily loss $80 hit. Bot stopped.','err'); stopBot(); return; }
  if (st.openPos.length >= st.cfg.maxOpen)        return;
  if (!st.togs.auto)                              return;
  if (Object.keys(st.prices).length < 3)          return;

  const syms = shuffle([...SYMBOLS]);
  for (const sym of syms) {
    if (st.openPos.find(t=>t.sym===sym)) continue;
    if (!st.wsReady[sym]) continue;
    const sig = getSignal(sym);
    if (sig && sig.conf >= 62 && !sig.weak) {
      await placeOrder(sym, sig.dir==='LONG'?'BUY':'SELL', st.cfg.size);
      break;
    }
  }
}

function toggleBot() { st.running ? stopBot() : startBot(); }

function startBot() {
  if (!st.connected) {
    toast('Connect your API keys first (Keys tab)');
    nav('setup'); return;
  }
  st.running = true;
  document.getElementById('mainBtn').textContent = 'â¹ STOP BOT';
  document.getElementById('mainBtn').className   = 'btn btn-r';
  document.getElementById('botBadge').textContent  = 'RUNNING';
  document.getElementById('botBadge').className    = 'badge b-run';
  log('ğŸš€ Demo Bot started â€” placing REAL demo orders on Binance!', 'ok');
  st.loopInterval    = setInterval(botLoop, 15_000);
  st.monitorInterval = setInterval(() => { monitorOpenPositions(); renderOpenPos(); updateDash(); }, 5_000);
  botLoop();
}

function stopBot() {
  st.running = false;
  clearInterval(st.loopInterval); clearInterval(st.monitorInterval);
  document.getElementById('mainBtn').textContent = 'â–¶ START DEMO BOT';
  document.getElementById('mainBtn').className   = 'btn btn-y';
  document.getElementById('botBadge').textContent  = 'STOPPED';
  document.getElementById('botBadge').className    = 'badge b-off';
  log('â¹ Bot stopped.', 'warn');
}

function resetSession() {
  stopBot();
  Object.assign(st,{capital:900,todayPnl:0,totalPnl:0,todayLoss:0,tradeCount:0,wins:0,losses:0,openPos:[],allTrades:[],pnlHistory:[0],tickStep:0});
  updateDash(); renderOpenPos(); renderTrades(); drawPnlChart();
  toast('Session reset âœ“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTopLosers() {
  try {
    const r=await fetch('https://api.binance.com/api/v3/ticker/24hr');
    const all=await r.json();
    const losers=all
      .filter(t=>t.symbol.endsWith('USDT')&&!t.symbol.includes('_')&&parseFloat(t.quoteVolume)>50000000)
      .sort((a,b)=>parseFloat(a.priceChangePercent)-parseFloat(b.priceChangePercent))
      .slice(0,20).map(t=>t.symbol);
    SYMBOLS=[...new Set([...losers,...SYMBOLS])].slice(0,40);
    log('ğŸ“‰ Top losers loaded: '+losers.slice(0,5).join(', ')+'â€¦','ok');
  }catch(e){log('Top losers failed: '+e.message,'warn');}
}

function runScan() {
  const searchTerm = (document.getElementById('symSearch')?.value||'').toUpperCase().trim();
  const scanSyms = searchTerm
    ? SYMBOLS.filter(s=>s.includes(searchTerm))
    : SYMBOLS;
  const results = scanSyms.map(sym => {
    const c=st.candles[sym]||[], price=st.prices[sym]||0, chg=st.change24h[sym]||0;
    return { sym, price, chg, rsi:c.length>=15?rsi(c):50, vs:c.length>=11?volSpike(c):1,
             sig:st.wsReady[sym]?getSignal(sym):null, ready:st.wsReady[sym] };
  }).sort((a,b)=>(b.sig?.conf||0)-(a.sig?.conf||0));

  const el = document.getElementById('scanList');
  el.innerHTML = results.map(r=>{
    const sig=r.sig;
    const cCol=r.chg>=0?'var(--green)':'var(--red)';
    const chipStyle=sig?(sig.dir==='LONG'?'background:rgba(0,230,118,.15);color:var(--green)':'background:rgba(255,77,109,.15);color:var(--red)'):'background:rgba(85,85,112,.15);color:var(--dim)';
    const iconBg=sig?(sig.dir==='LONG'?'rgba(0,230,118,.1)':'rgba(255,77,109,.1)'):'rgba(85,85,112,.1)';
    const dynLev = r.ready ? getDynamicLeverage(r.sym) : st.cfg.leverage;
    const levCol = dynLev>=15?'var(--green)':dynLev>=8?'var(--accent)':dynLev>=5?'var(--yellow)':'var(--red)';
    return `<div class="srow" onclick="openSheet('${r.sym}')">
      <div class="sico" style="background:${iconBg}">${ICONS[r.sym]||r.sym.slice(0,2)}</div>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:700">${r.sym.replace('USDT','/USDT')} <span style="font-size:10px;color:${levCol};font-family:var(--mono)">${dynLev}x</span></div>
        <div style="font-size:10px;color:var(--dim);margin-top:2px">${sig?sig.reason:(r.ready?'No signal':`Loading (${(st.candles[r.sym]||[]).length}/50)`)} Â· RSI ${r.rsi.toFixed(1)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-family:var(--mono);font-size:13px;font-weight:700;color:${cCol}">${r.chg>=0?'+':''}${r.chg.toFixed(2)}%</div>
        <div style="display:inline-block;font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;margin-top:3px;${chipStyle}">${sig?(sig.signals+'âœ“ '+sig.dir+' '+sig.conf+'%'):'WAIT'}</div>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDash() {
  const pnl=st.todayPnl, cap=900+st.totalPnl;
  const wr=st.wins+st.losses>0?Math.round(st.wins/(st.wins+st.losses)*100):null;

  setText('s-cap',`$${cap.toFixed(2)}`);
  const pe=document.getElementById('s-pnl');
  pe.textContent=`${pnl>=0?'+':''}$${pnl.toFixed(2)}`; pe.className=`sv ${pnl>=0?'g':'r'}`;
  setText('s-pct',`${((pnl/900)*100).toFixed(2)}%`);
  setText('s-trades',`${st.tradeCount}/${st.cfg.maxTrades}`);
  setText('s-wr',wr!==null?`${wr}%`:'â€”');
  setText('s-wl',`${st.wins}W / ${st.losses}L`);
  setText('posCount',`${st.openPos.length} open`);

  const p1=Math.min(Math.max(pnl,0)/200*100,100);
  document.getElementById('p1').style.width=p1+'%'; setText('p1t',`$${Math.max(pnl,0).toFixed(2)}`);
  document.getElementById('p2').style.width=(st.tradeCount/st.cfg.maxTrades*100)+'%'; setText('p2t',`${st.tradeCount}/${st.cfg.maxTrades}`);
  document.getElementById('p3').style.width=Math.min(st.todayLoss/80*100,100)+'%'; setText('p3t',`$${st.todayLoss.toFixed(2)}`);

  setText('t-total',st.allTrades.length);
  const tpe=document.getElementById('t-pnl');
  tpe.textContent=`${st.totalPnl>=0?'+':''}$${st.totalPnl.toFixed(2)}`; tpe.className=`sv ${st.totalPnl>=0?'g':'r'}`;
  const closed=st.allTrades.filter(t=>t.status!=='OPEN');
  if(closed.length){const pnls=closed.map(t=>t.pnl);setText('t-best',`+$${Math.max(...pnls).toFixed(2)}`);setText('t-worst',`-$${Math.abs(Math.min(...pnls)).toFixed(2)}`);}
  drawPnlChart();
}

function renderOpenPos() {
  const el=document.getElementById('openPos');
  if(!st.openPos.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“­</div>No open positions</div>';return;}
  el.innerHTML=st.openPos.map(t=>{
    const cur=st.prices[t.sym]||t.price;
    const pnl=t.dir==='BUY'?t.notional*(cur-t.price)/t.price:-t.notional*(cur-t.price)/t.price;
    t.pnl=pnl;
    return `<div class="tr">
      <div style="flex:1">
        <div class="tr-sym">${t.sym.replace('USDT','/USDT')}</div>
        <div class="tr-meta">
          <span class="chip c-open">DEMO</span>
          <span class="chip ${t.dir==='BUY'?'c-long':'c-short'}">${t.dir==='BUY'?'LONG':'SHORT'}</span>
          $${t.size}Ã—${t.lev}x
        </div>
        <div class="tr-meta" style="margin-top:2px">TP $${fmt(t.tpPrice)} Â· SL $${fmt(t.slPrice)}</div>
        <div class="tr-meta" style="margin-top:3px">
          <span style="color:var(--dim);cursor:pointer;font-size:11px" onclick="closePosition(st.openPos.find(x=>x.id==${t.id}))">âœ• Close</span>
        </div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div class="tr-pnl" style="color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl>=0?'+':''}$${pnl.toFixed(2)}</div>
        <div style="font-size:10px;color:var(--dim)">$${fmt(cur)}</div>
        <div style="font-size:10px;color:var(--dim)">${t.time}</div>
      </div>
    </div>`;
  }).join('');
  setText('posCount',`${st.openPos.length} open`);
}

function renderTrades() {
  const el=document.getElementById('tradeList');
  const closed=st.allTrades.filter(t=>t.status!=='OPEN');
  if(!closed.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div>No closed trades yet</div>';return;}
  el.innerHTML=closed.map(t=>`
    <div class="tr">
      <div>
        <div class="tr-sym">${t.sym.replace('USDT','/USDT')}</div>
        <div class="tr-meta">
          <span class="chip ${t.dir==='BUY'?'c-long':'c-short'}">${t.dir==='BUY'?'LONG':'SHORT'}</span>
          <span class="chip ${t.status==='WIN'?'c-win':'c-loss'}">${t.status}</span>
          $${t.size}Ã—${t.lev}x
        </div>
        <div class="tr-meta" style="font-size:10px;margin-top:2px">Order #${t.orderId||'â€”'}</div>
      </div>
      <div style="text-align:right">
        <div class="tr-pnl" style="color:${t.pnl>=0?'var(--green)':'var(--red)'}">${t.pnl>=0?'+':''}$${t.pnl.toFixed(2)}</div>
        <div style="font-size:10px;color:var(--dim)">${t.time}</div>
      </div>
    </div>`).join('');
}

function updateTicker() {
  const el=document.getElementById('tickerInner');
  const items=SYMBOLS.slice(0,8).map(sym=>{
    const p=st.prices[sym],c=st.change24h[sym]||0;
    if(!p) return '';
    const col=c>=0?'var(--green)':'var(--red)';
    return `<div class="ti"><span class="ti-s">${sym.replace('USDT','')}</span><span class="ti-p">$${fmt(p)}</span><span class="ti-c" style="color:${col}">${c>=0?'+':''}${c.toFixed(2)}%</span></div>`;
  }).filter(Boolean);
  if(!items.length) return;
  el.innerHTML=[...items,...items].join('');
  el.className='ticker-inner go';
}

function drawPnlChart() {
  const canvas=document.getElementById('pnlChart');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const w=canvas.offsetWidth,h=canvas.offsetHeight;
  canvas.width=w*devicePixelRatio; canvas.height=h*devicePixelRatio;
  ctx.scale(devicePixelRatio,devicePixelRatio);
  const data=st.pnlHistory;
  if(data.length<2){ctx.clearRect(0,0,w,h);return;}
  ctx.clearRect(0,0,w,h);
  const min=Math.min(...data),max=Math.max(...data),range=max-min||1;
  const pts=data.map((v,i)=>({x:(i/(data.length-1))*w,y:h-((v-min)/range)*(h-8)-4}));
  const isPos=data[data.length-1]>=0;
  const grad=ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,isPos?'rgba(0,230,118,.3)':'rgba(255,77,109,.3)');
  grad.addColorStop(1,'rgba(0,0,0,0)');
  ctx.beginPath(); ctx.moveTo(pts[0].x,h);
  pts.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.lineTo(pts[pts.length-1].x,h); ctx.closePath();
  ctx.fillStyle=grad; ctx.fill();
  ctx.beginPath(); pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
  ctx.strokeStyle=isPos?'#00e676':'#ff4d6d'; ctx.lineWidth=2; ctx.stroke();
  const zy=h-((0-min)/range)*(h-8)-4;
  ctx.beginPath(); ctx.moveTo(0,zy); ctx.lineTo(w,zy);
  ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.lineWidth=1; ctx.setLineDash([4,4]); ctx.stroke(); ctx.setLineDash([]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHEET / MANUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSheet(sym) {
  const p=st.prices[sym]||0, c=st.change24h[sym]||0;
  const candles=st.candles[sym]||[];
  const r=candles.length>=15?rsi(candles):50;
  const vs=candles.length>=11?volSpike(candles):1;
  const sig=st.wsReady[sym]?getSignal(sym):null;
  document.getElementById('sh-title').textContent=sym.replace('USDT','/USDT');
  document.getElementById('sh-body').innerHTML=`
    <div class="sg" style="margin-bottom:14px">
      <div class="sb la"><div class="sl">Live Price</div><div class="sv a" style="font-size:16px">$${fmt(p)}</div></div>
      <div class="sb ${c>=0?'lg':'lr'}"><div class="sl">24h</div><div class="sv ${c>=0?'g':'r'}" style="font-size:16px">${c>=0?'+':''}${c.toFixed(2)}%</div></div>
      <div class="sb ly"><div class="sl">RSI</div><div class="sv y" style="font-size:16px">${r.toFixed(1)}</div></div>
      <div class="sb la"><div class="sl">Vol Spike</div><div class="sv a" style="font-size:16px">${vs.toFixed(2)}x</div></div>
    </div>
    <div style="margin-bottom:14px;padding:10px;background:var(--surface);border-radius:8px;border:1px solid var(--border)">
      <div style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--dim);margin-bottom:4px">Signal</div>
      <div style="font-size:14px;font-weight:700;color:${sig?(sig.dir==='LONG'?'var(--green)':'var(--red)'):'var(--dim)'}">
        ${sig?`${sig.dir} â€” ${sig.conf}% confidence`:(st.wsReady[sym]?'No signal':'Building candlesâ€¦')}
      </div>
      <div style="font-size:11px;color:var(--dim);margin-top:3px">${sig?sig.reason:`${candles.length}/20 candles`}</div>
    </div>
    <div class="b2">
      <button class="btn btn-g" onclick="sheetOrder('${sym}','BUY')">â–² DEMO LONG</button>
      <button class="btn btn-r" onclick="sheetOrder('${sym}','SELL')">â–¼ DEMO SHORT</button>
    </div>`;
  document.getElementById('sheet').classList.add('show');
}
function closeSheet(){ document.getElementById('sheet').classList.remove('show'); }
async function sheetOrder(sym,dir){ closeSheet(); await placeOrder(sym,dir,st.cfg.size); }

async function manualOrder(dir) {
  const sym  = document.getElementById('manSym').value;
  const size = parseFloat(document.getElementById('manSize').value)||st.cfg.size;
  const lev  = parseInt(document.getElementById('manLev').value)||st.cfg.lev;
  st.cfg.leverage = lev;
  await placeOrder(sym, dir==='BUY'?'BUY':'SELL', size);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setBanner(type, msg) {
  const b=document.getElementById('connBanner'), d=document.getElementById('connDot'), t=document.getElementById('connText');
  b.className=`banner bn-${type}`; t.textContent=msg;
  d.className=`bn-dot ${type==='ok'?'pulse':''}`;
}
function saveConfig(){
  st.cfg.strategy=document.getElementById('cfgStrat').value;
  st.cfg.size=parseFloat(document.getElementById('cfgSize').value)||45;
  st.cfg.leverage=parseInt(document.getElementById('cfgLev').value)||5;
  st.cfg.tp=parseFloat(document.getElementById('cfgTP').value)||10;
  st.cfg.sl=parseFloat(document.getElementById('cfgSL').value)||8;
  st.cfg.maxTrades=parseInt(document.getElementById('cfgMaxT').value)||20;
  st.cfg.maxOpen=parseInt(document.getElementById('cfgMaxP').value)||3;
  toast('Config saved âœ“');
  if(st.connected) updateAPIStatus();
}
function togSet(k){ st.togs[k]=!st.togs[k]; document.getElementById('tog-'+k).classList.toggle('on',st.togs[k]); }
function toggleEye(id, btn){ const i=document.getElementById(id); i.type=i.type==='password'?'text':'password'; btn.textContent=i.type==='password'?'ğŸ‘':'ğŸ™ˆ'; }

function log(msg, type='info') {
  const el=document.getElementById('logBox');
  if (!el) return;
  const t=new Date().toLocaleTimeString('en',{hour12:false});
  const d=document.createElement('div'); d.className=`ll ${type}`;
  d.innerHTML=`<span class="lt">${t}</span>${msg}`;
  el.appendChild(d); el.scrollTop=el.scrollHeight;
  if(el.children.length>400) el.removeChild(el.firstChild);
}

function clearHistory(){ st.allTrades=st.allTrades.filter(t=>t.status==='OPEN'); st.wins=0;st.losses=0;st.totalPnl=0;st.pnlHistory=[0]; renderTrades();updateDash();toast('Cleared'); }
function setText(id,v){ const e=document.getElementById(id);if(e)e.textContent=v; }
function shuffle(a){ return [...a].sort(()=>Math.random()-.5); }
function fmt(n){ if(!n&&n!==0)return'â€”';if(n>=10000)return n.toFixed(1);if(n>=100)return n.toFixed(2);if(n>=1)return n.toFixed(3);if(n>=0.1)return n.toFixed(4);return n.toFixed(6); }
function toast(msg){ const el=document.createElement('div');el.className='toast';el.textContent=msg;document.body.appendChild(el);setTimeout(()=>el.style.opacity='0',1800);setTimeout(()=>el.remove(),2100); }

async function forceScan() {
  if (!st.connected){ toast('Connect API keys first'); nav('keys'); return; }
  log('â–¶ Manual scan triggeredâ€¦','info');
  await botLoop();
}

function nav(page) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('pg-'+page).classList.add('active');
  ['dash','scanner','trades','config','setup'].forEach((p,i)=>{
    if(p===page) document.querySelectorAll('.tab')[i].classList.add('active');
  });
  if(page==='trades') renderTrades();
  if(page==='scanner') runScan();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', () => {
  // Restore session keys if available
  const k=localStorage.getItem('demoKey'), s=localStorage.getItem('demoSecret'), px=localStorage.getItem('demoProxy');
  if(px) activeProxy=px;
  if(k && s) {
    document.getElementById('apiKey').value    = k;
    document.getElementById('apiSecret').value = s;
    log('ğŸ”‘ Saved keys found â€” auto-reconnectingâ€¦','warn');
    // Auto-reconnect on page load
    setTimeout(()=>{
      document.getElementById('connectBtn').click();
    }, 1500);
  }

  updateDash(); drawPnlChart();
  document.getElementById('sheet').addEventListener('click',e=>{ if(e.target===document.getElementById('sheet')) closeSheet(); });
  window.addEventListener('resize', drawPnlChart);
  setInterval(()=>{ renderOpenPos(); updateDash(); }, 5000);

  log('â—ˆ Binance Demo Bot ready.','ok');
  log('ğŸ‘‰ Go to the Keys tab â†’ paste your demo-fapi API keys â†’ tap Connect','info');
});
</script>
</body>
</html>
